name: clip-batch-inference

resources:
  accelerators: {L4:1, A10G:1, A10:1, V100:1}
  memory: 32+
  any_of:
    - use_spot: true 
    - use_spot: false

num_nodes: 1

file_mounts:
  /output:
    name: sky-clip-embedding
    mode: MOUNT

envs:
  HF_TOKEN: ${HF_TOKEN}
  START_IDX: ${START_IDX}
  END_IDX: ${END_IDX}

workdir: ~/skypilot/examples/batch_inference

setup: |
  pip install numpy==1.26.4
  pip install torch==2.5.1 torchvision==0.20.1 ftfy regex tqdm
  pip install datasets webdataset requests Pillow open_clip_torch
  pip install fastapi uvicorn aiohttp pandas pyarrow tenacity

run: |
  python batch_process_clip.py \
    --output-path "/output/embeddings_${START_IDX}_${END_IDX}.parquet" \
    --start-idx ${START_IDX} \
    --end-idx ${END_IDX} \
    --batch-size 50 \
    --checkpoint-size 1000 \
    --model-name "ViT-bigG-14" \
    --dataset-name "laion/relaion2B-en-research-safe"

  echo "Processing complete. Results saved in node-specific files under /output/"
  ls -l /output