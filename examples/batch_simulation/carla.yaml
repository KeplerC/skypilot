name: carla-batch-simulation

resources:
  accelerators: T4:1  # Using T4 GPU for CARLA
  memory: 16+
  cloud: aws

num_nodes: 1

file_mounts:
  /results:
    name: kych-simulation-results
    store: s3
    mode: MOUNT

workdir: ~/skypilot/examples/batch_simulation

setup: |
  # Install system dependencies
  sudo apt-get update
  sudo apt-get install -y python3-pip python3-opencv
  
  # Install Python dependencies
  pip install numpy opencv-python carla filterpy scipy

  # Pull and start CARLA Docker container
  docker pull carlasim/carla:0.9.15
  docker run -d \
    --name=carla \
    --privileged \
    --gpus all \
    --net=host \
    -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
    carlasim/carla:0.9.15 \
    /bin/bash ./CarlaUE4.sh -RenderOffScreen

  # Wait for CARLA to start
  sleep 10

run: |
  # Get task-specific parameters from environment variables
  DELTA_K=${DELTA_K}
  BRAKE_THRESHOLD=${BRAKE_THRESHOLD}
  CONFIG_TYPE=${CONFIG_TYPE}
  RUN_NUMBER=${RUN_NUMBER}
  DIR_NAME=${CONFIG_TYPE}-dk${DELTA_K}-bt${BRAKE_THRESHOLD}-run${RUN_NUMBER}
  
  # Create results directory
  mkdir -p /results/${DIR_NAME}
  mkdir -p ./monte_carlo_results
  mkdir -p ./bev_images

  # Run simulation
  python3 carla_simulation.py \
    --cautious_delta_k ${DELTA_K} \
    --config_type ${CONFIG_TYPE} \
    --emergency_brake_threshold ${BRAKE_THRESHOLD} \
    --output_dir /results/${DIR_NAME}

  # Copy results
  cp -r ./monte_carlo_results/* /results/${DIR_NAME}/
  cp ./collision_probabilities.csv /results/${DIR_NAME}/
  cp -r ./bev_images/* /results/${DIR_NAME}/