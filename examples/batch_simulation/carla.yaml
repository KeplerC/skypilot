name: carla-batch-simulation

resources:
  accelerators: T4:1  # Using T4 GPU for CARLA
  memory: 16+
  use_spot: true

num_nodes: 1

file_mounts:
  /results:
    name: kych-simulation-results
    store: s3
    mode: MOUNT

workdir: ~/skypilot/examples/batch_simulation

setup: |
  # Install system dependencies
  sudo apt-get update
  sudo apt-get install -y python3-pip python3-opencv
  
  # Install Python dependencies
  pip install numpy opencv-python carla filterpy scipy sympy

  # Pull and start CARLA Docker container
  docker pull carlasim/carla:0.9.15

run: |
  # Get task-specific parameters from environment variables
  DELTA_K=${DELTA_K}
  BRAKE_THRESHOLD=${BRAKE_THRESHOLD}
  CONFIG_TYPE=${CONFIG_TYPE}
  NUM_RUNS=${NUM_RUNS}
  
  # Create base results directory
  BASE_DIR=/results/${CONFIG_TYPE}-dk${DELTA_K}-bt${BRAKE_THRESHOLD}
  mkdir -p ${BASE_DIR}
  
  # Run multiple trials
  for RUN_NUMBER in $(seq 1 ${NUM_RUNS}); do
    echo "Starting trial ${RUN_NUMBER}/${NUM_RUNS}"
    
    # Create trial-specific directories
    TRIAL_DIR=${BASE_DIR}/run${RUN_NUMBER}
    mkdir -p ${TRIAL_DIR}
    
    echo "running command: python3 carla_simulation.py \
      --cautious_delta_k ${DELTA_K} \
      --config_type ${CONFIG_TYPE} \
      --emergency_brake_threshold ${BRAKE_THRESHOLD} \
      --output_dir ${TRIAL_DIR}"
    
    python3 carla_simulation.py \
      --cautious_delta_k ${DELTA_K} \
      --config_type ${CONFIG_TYPE} \
      --emergency_brake_threshold ${BRAKE_THRESHOLD} \
      --output_dir ${TRIAL_DIR}
    
    # Optional: restart CARLA between trials to ensure clean state
    docker restart carla
    sleep 5
  done